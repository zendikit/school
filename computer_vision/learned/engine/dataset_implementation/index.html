
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Zendikit educational material">
      
      
        <meta name="author" content="Zendikit">
      
      
        <link rel="canonical" href="https://zendikit.school/computer_vision/learned/engine/dataset_implementation/">
      
      <link rel="icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.3.9">
    
    
      
        <title>Dataset Implementation - Zendikit School</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.1d29e8d0.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.cbb835fc.min.css">
        
          
          
          <meta name="theme-color" content="#ffffff">
        
      
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="white" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#dataset-implementation" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="Zendikit School" class="md-header__button md-logo" aria-label="Zendikit School" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Zendikit School
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Dataset Implementation
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="Zendikit School" class="md-nav__button md-logo" aria-label="Zendikit School" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Zendikit School
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Japanese
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Japanese" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Japanese
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1" type="checkbox" id="__nav_2_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_1">
          Grammar
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Grammar" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_1">
          <span class="md-nav__icon md-icon"></span>
          Grammar
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../japanese/grammar/introduction/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../japanese/grammar/n5/" class="md-nav__link">
        N5
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../japanese/grammar/n4/" class="md-nav__link">
        N4
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Computer Vision
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Computer Vision" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Computer Vision
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1" type="checkbox" id="__nav_3_1" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3_1">
          Learned
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Learned" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_1">
          <span class="md-nav__icon md-icon"></span>
          Learned
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../introduction/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1_2" type="checkbox" id="__nav_3_1_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3_1_2">
          Engine
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Engine" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_1_2">
          <span class="md-nav__icon md-icon"></span>
          Engine
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../skeleton/" class="md-nav__link">
        Skeleton
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../skeleton_implementation/" class="md-nav__link">
        Skeleton Implementation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../datasets/" class="md-nav__link">
        Datasets
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Dataset Implementation
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Dataset Implementation
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#trainerpy" class="md-nav__link">
    trainer.py
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#factorypy" class="md-nav__link">
    factory.py
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#stub_configjson" class="md-nav__link">
    stub_config.json
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#imagenettepy" class="md-nav__link">
    imagenette.py
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing" class="md-nav__link">
    Testing
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../dataset_visualization/" class="md-nav__link">
        Dataset Visualization
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../dataset_visualization_implementation/" class="md-nav__link">
        Dataset Visualization Implementation
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#trainerpy" class="md-nav__link">
    trainer.py
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#factorypy" class="md-nav__link">
    factory.py
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#stub_configjson" class="md-nav__link">
    stub_config.json
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#imagenettepy" class="md-nav__link">
    imagenette.py
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing" class="md-nav__link">
    Testing
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                


<h1 id="dataset-implementation">Dataset Implementation</h1>
<h2 id="trainerpy">trainer.py</h2>
<p>Below are our changes to our trainer.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># ...</span>

<span class="kn">from</span> <span class="nn">engine.configuration</span> <span class="kn">import</span> <span class="n">load_config</span>
<span class="kn">from</span> <span class="nn">engine.datasets.factory</span> <span class="kn">import</span> <span class="n">load_dataset</span>
<span class="kn">from</span> <span class="nn">engine.models</span> <span class="kn">import</span> <span class="n">build_model</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># ...</span>

    <span class="n">config</span> <span class="o">=</span> <span class="n">load_config</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
    <span class="n">training_dataset</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">validation_dataset</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">build_model</span><span class="p">()</span>

    <span class="c1"># ...</span>
</code></pre></div>
<p>We now import <code>load_dataset</code> from <code>engine.datasets.factory.py</code>. Also, we
instantiate both a <code>training_dataset</code> and <code>validation_dataset</code>. We pass the
<code>config</code> into <code>load_dataset</code> since the configuration contains not only the name
of the dataset we want to load but also additional values the dataset instance
itself will need. <code>load_dataset</code> also features a <code>training</code> parameter that we
use to indicate whether we want to load training data or validation data.</p>
<h2 id="factorypy">factory.py</h2>
<p><code>factory.py</code> looks as follows.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Sequence</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span>

<span class="kn">from</span> <span class="nn">engine.datasets.imagenette</span> <span class="kn">import</span> <span class="n">Imagenette</span>


<span class="k">def</span> <span class="nf">load_dataset</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">training</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load a dataset.</span>

<span class="sd">    @p config A configuration dictionary. The nested key `dataset.name` is</span>
<span class="sd">              required.</span>
<span class="sd">    @p training If True, load only training data; else only validation data.</span>
<span class="sd">    @return An instance of a loaded dataset.</span>
<span class="sd">    @exception ValueError `name` doesn&#39;t name a known dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;dataset&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="n">Imagenette</span><span class="o">.</span><span class="vm">__name__</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Imagenette</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">training</span><span class="p">)</span>

    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> doesn&#39;t name a known dataset&quot;</span><span class="p">)</span>
</code></pre></div>
<p>In the documentation, we declare the required keys in the configuration. This
practice is important because <code>config</code> is otherwise opaque--we don't know which
keys and values it has, and our users won't know which we require unless we
document our expectations.</p>
<p><code>load_dataset</code> expects that all datasets implement the
<code>collections.abc.Sequence</code> interface, so we have <code>load_dataset</code> declare that it
simply returns something you can iterate over. Also, we compare
<code>name == Imagenette.__name__</code> instead of comparing <code>name == "Imagenette"</code>
because, were someone to refactor <code>Imagenette</code> and change its name, the
condition here will always check against the class name proper and not a
potentially out-of-date string.</p>
<h2 id="stub_configjson">stub_config.json</h2>
<p>Our configuration now looks as follows.</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;dataset&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Imagenette&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;path&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/abs/path/to/imagenette2/noisy_imagenette.csv&quot;</span><span class="w"></span>
<span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;trainer&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;num_iters&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>We add a new <code>dataset</code> object that contains the name of the dataset, which we
choose to match the name of the class we implemented, and a path to a file
describing the dataset.</p>
<h2 id="imagenettepy">imagenette.py</h2>
<p>Lastly, here is our implementation of <code>engine/datasets/imagenette.py</code>.</p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;Provides the imagenette2 dataset.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Sequence</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">NamedTuple</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="nn">torchvision</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>


<span class="k">class</span> <span class="nc">_PathAndClass</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span>
    <span class="bp">cls</span><span class="p">:</span> <span class="nb">str</span>


<span class="k">class</span> <span class="nc">Imagenette</span><span class="p">(</span><span class="n">Sequence</span><span class="p">,</span> <span class="n">Visualizable</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">training</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        @p config A configuration dictionary. The nested key `dataset.path` is</span>
<span class="sd">                   required. `dataset.path` is assumed to point to</span>
<span class="sd">                   noisy_imagenette.csv.</span>
<span class="sd">        @p training If True, load only training data; else only validation data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">csv_pathname</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;dataset&quot;</span><span class="p">][</span><span class="s2">&quot;path&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_class_remapper</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;n01440764&quot;</span><span class="p">:</span> <span class="s2">&quot;tench&quot;</span><span class="p">,</span>
            <span class="s2">&quot;n02102040&quot;</span><span class="p">:</span> <span class="s2">&quot;english_springer&quot;</span><span class="p">,</span>
            <span class="s2">&quot;n02979186&quot;</span><span class="p">:</span> <span class="s2">&quot;cassette_player&quot;</span><span class="p">,</span>
            <span class="s2">&quot;n03000684&quot;</span><span class="p">:</span> <span class="s2">&quot;chainsaw&quot;</span><span class="p">,</span>
            <span class="s2">&quot;n03028079&quot;</span><span class="p">:</span> <span class="s2">&quot;church&quot;</span><span class="p">,</span>
            <span class="s2">&quot;n03394916&quot;</span><span class="p">:</span> <span class="s2">&quot;french_horn&quot;</span><span class="p">,</span>
            <span class="s2">&quot;n03417042&quot;</span><span class="p">:</span> <span class="s2">&quot;garbage_truck&quot;</span><span class="p">,</span>
            <span class="s2">&quot;n03425413&quot;</span><span class="p">:</span> <span class="s2">&quot;gas_pump&quot;</span><span class="p">,</span>
            <span class="s2">&quot;n03445777&quot;</span><span class="p">:</span> <span class="s2">&quot;golf_ball&quot;</span><span class="p">,</span>
            <span class="s2">&quot;n03888257&quot;</span><span class="p">:</span> <span class="s2">&quot;parachute&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">_PathAndClass</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_to_tensor</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">()</span>

        <span class="c1"># Build the dataset index.</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_pathname</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="c1"># Indices into a row in the CSV file.</span>
            <span class="n">img_path_idx</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">class_idx</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">valid_idx</span> <span class="o">=</span> <span class="mi">6</span>

            <span class="n">base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">csv_pathname</span><span class="p">)</span>

            <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="nb">next</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>  <span class="c1"># Skip the first (header) row.</span>

            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
                <span class="n">is_valid</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;True&quot;</span>
                <span class="c1"># Skip samples that don&#39;t match our dataset type (train/valid).</span>
                <span class="k">if</span> <span class="n">training</span> <span class="ow">and</span> <span class="n">is_valid</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">training</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_valid</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">img_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="n">img_path_idx</span><span class="p">])</span>
                <span class="n">img_class</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">class_idx</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_PathAndClass</span><span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="n">img_class</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;@return The number of samples in the dataset.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        @p index An index into the dataset. Positive numbers must be less than</span>
<span class="sd">                 len(dataset).</span>
<span class="sd">        @return A dictionary with:</span>
<span class="sd">                &quot;inputs&quot;: A torch.Tensor containing the image as (C, H, W).</span>
<span class="sd">                &quot;targets&quot;: The class of the object in the `inputs` tensor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="s2">&quot;Positive index out of range.&quot;</span>

        <span class="k">with</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">img</span><span class="p">:</span>
            <span class="n">img_tensor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_tensor</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="n">img_tensor</span><span class="p">,</span>
            <span class="s2">&quot;targets&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_class_remapper</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">cls</span><span class="p">],</span>
        <span class="p">}</span>
</code></pre></div>
<p>Let's jump right to the <code>Imagenette</code> implementation.</p>
<p>As with <code>load_dataset</code>, we document our key and value expectations for <code>config</code>.</p>
<p>We provide our class name remapper as <code>self._class_remapper</code>. Next, we
initialize our dataset index as <code>self._data</code>.</p>
<p><code>self._data</code> is a list of <code>_PathAndClass</code> instances. <code>_PathAndClass</code> serves only
to hold a path to an image and the class of the image in our context, and it
derives from <code>typing.NamedTuple</code> to allow us to annotate the field names. We
could use a plain tuple, but we would then be lacking the self-documenting
property of a named tuple.</p>
<p>Next we instantiate a
<a href="https://pytorch.org/vision/main/generated/torchvision.transforms.ToTensor.html"><code>torchvision.transforms.ToTensor</code></a>.
We'll discuss this more later.</p>
<p>Finally in <code>__init__</code>, we iterate through the CSV file's rows and build our
dataset index.</p>
<p><code>__len__</code> is self-explanatory.</p>
<p><code>__getitem__</code> uses
<a href="https://pillow.readthedocs.io/en/stable/reference/Image.html"><code>Pillow.Image</code></a>
to load an image from disk. We then use our aforementioned <code>self._to_tensor</code>
Torchvision transformation to convert the Pillow image to a Torch tensor.
Finally, we build the dictionary to return but remap the sample's class name
before adding it to the dictionary.</p>
<h2 id="testing">Testing</h2>
<p>We could imagine adding a test for <code>Imagenette</code>. The test might confirm the
number of training and validation samples loaded, check that the first and last
sample of each dataset matches what is specified in <code>noisy_imagenette.csv</code>, and
also fetch a sample out of the datasets and confirm the returned dictionary's
keys and values.</p>
<p>This all relies on the data being available, though, which is not a big problem
for us right now but quickly becomes a problem when developing an engine at
scale, where we have an arbitrary number of developers contributing to the
source code. We can't anticipate where each dataset we might need for tests
lives on disk in the runtime without the user doing so manual work to specify
it. Also, if the datasets are massive, it's unfriendly to require other
developers to have to download them to run the tests.</p>
<p>If we run our tests in a consistent, standardized environment, though, such as
containerized as part of some continuous integration, then these tests become
more feasible. An alternative is to create a very small subset of a large
dataset and use this in testing. Locating this on an end-user's system reliably
could be done by having the engine itself fetch the dataset from some networked
server, for example.</p>
<p>In our case here, we'll do a manual test only. For example, we can use
<a href="https://docs.python.org/3/library/pdb.html">the Python debugger</a> and break
somewhere in <code>trainer.py</code>.</p>
<div class="highlight"><pre><span></span><code><span class="n">config</span> <span class="o">=</span> <span class="n">load_config</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
<span class="n">training_dataset</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">validation_dataset</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">breakpoint</span><span class="p">()</span>  <span class="c1"># Stop here.</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">build_model</span><span class="p">()</span>
</code></pre></div>
<p>We could then inspect the datasets in the debugger.</p>
<div class="highlight"><pre><span></span><code>(Pdb) p len(training_dataset)
9469
(Pdb) p len(validation_dataset)
3925
(Pdb) p training_dataset[0]
{&#39;inputs&#39;: tensor(  # ...
         ), &#39;targets&#39;: &#39;cassette_player&#39;}
(Pdb) p training_dataset[-1]
{&#39;inputs&#39;: tensor(  # ...
         ), &#39;targets&#39;: &#39;gas_pump&#39;}
</code></pre></div>

              
            </article>
            
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../datasets/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Datasets" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Datasets
            </div>
          </div>
        </a>
      
      
        
        <a href="../dataset_visualization/" class="md-footer__link md-footer__link--next" aria-label="Next: Dataset Visualization" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Dataset Visualization
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://zendikit.work" target="_blank" rel="noopener" title="zendikit.work" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M40 32c13.25 0 24 10.75 24 24v400c0 13.3-10.75 24-24 24H24c-13.25 0-24-10.7-24-24V56c0-13.25 10.75-24 24-24h16zm88 16v416c0 8.8-7.2 16-16 16s-16-7.2-16-16V48c0-8.84 7.2-16 16-16s16 7.16 16 16zm72-16c13.3 0 24 10.75 24 24v400c0 13.3-10.7 24-24 24h-16c-13.3 0-24-10.7-24-24V56c0-13.25 10.7-24 24-24h16zm96 0c13.3 0 24 10.75 24 24v400c0 13.3-10.7 24-24 24h-16c-13.3 0-24-10.7-24-24V56c0-13.25 10.7-24 24-24h16zm152 24c0-13.25 10.7-24 24-24h16c13.3 0 24 10.75 24 24v400c0 13.3-10.7 24-24 24h-16c-13.3 0-24-10.7-24-24V56zm-64-8c0-8.84 7.2-16 16-16s16 7.16 16 16v416c0 8.8-7.2 16-16 16s-16-7.2-16-16V48z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../../../..", "features": [], "search": "../../../../assets/javascripts/workers/search.b97dbffb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.6c7ad80a.min.js"></script>
      
    
  </body>
</html>